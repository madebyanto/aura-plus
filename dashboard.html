<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — Aura</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
  :root{
    --bg1:#E30AF5; --bg2:#F174FF;
    --glass: rgba(255,255,255,0.12);
    --glass-2: rgba(255,255,255,0.08);
    --muted: rgba(255,255,255,0.85);
    --accent: #f174ff;
    --white: #ffffff;
  }

  *{box-sizing:border-box; margin:0; padding:0}
  html,body{height:100%; font-family:'Poppins',sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--white); -webkit-font-smoothing:antialiased;}
  a{color:inherit; text-decoration:none}

  /* Container mobile-first */
  .wrap{
    max-width:720px;
    margin:0 auto;
    padding:18px 16px 90px; /* spazio per bottom nav */
  }

  /* Header area inside page (not fixed) */
  .page-header{
    display:flex; align-items:center; gap:12px; margin-bottom:12px;
  }
  .logo-pill{
    width:52px; height:52px; border-radius:12px; display:grid; place-items:center;
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75));
    color:#000; font-weight:700;
  }
  .page-title{font-size:18px; font-weight:600}
  .page-sub{font-size:12px; color:var(--muted); margin-top:2px}

  /* Cards */
  .card{
    background: var(--glass);
    border-radius:14px;
    padding:14px;
    margin-bottom:12px;
    box-shadow: 0 12px 36px rgba(0,0,0,0.22);
    backdrop-filter: blur(12px);
  }

  /* Profile compact */
  .profile-row{display:flex; gap:12px; align-items:center}
  .avatar{
    width:78px; height:78px; border-radius:50%; overflow:hidden; flex:0 0 78px; border:3px solid rgba(255,255,255,0.18);
    background:linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  }
  .avatar img{width:100%; height:100%; object-fit:cover; display:block}

  .profile-meta{flex:1}
  .profile-meta h2{font-size:16px; margin-bottom:4px}
  .profile-meta p{font-size:13px; color:var(--muted); margin-bottom:6px}

  .mini-stats{display:flex; gap:10px; margin-top:6px}
  .stat{flex:1; background: rgba(255,255,255,0.03); padding:8px; border-radius:10px; text-align:center}
  .stat .label{font-size:12px; color:var(--muted)}
  .stat .value{font-weight:700; margin-top:6px}

  /* Bio terminal */
  .bio-terminal{
    margin-top:10px;
    font-family: 'Courier New', monospace;
    background: rgba(0,0,0,0.24);
    padding:10px; border-radius:10px;
    min-height:72px; white-space:pre-wrap; overflow:auto; font-size:13px;
  }

  /* News list simple */
  .news-item{
    padding:10px; border-radius:10px; background: rgba(255,255,255,0.03); margin-bottom:8px;
  }
  .news-item h4{font-size:14px; margin-bottom:6px}
  .news-item p{font-size:13px; color:var(--muted)}

  /* Settings list */
  .settings-list{display:flex; flex-direction:column; gap:8px}
  .settings-row{display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background: rgba(255,255,255,0.03)}

  /* Bottom navigation (fixed) */
  .bottom-nav{
    position:fixed; left:0; right:0; bottom:0; height:72px;
    display:flex; justify-content:center; align-items:center;
    background: linear-gradient(180deg, rgba(0,0,0,0.14), rgba(0,0,0,0.08));
    border-top:1px solid rgba(255,255,255,0.04);
    z-index:30;
    padding:10px 12px;
  }
  .nav-inner{
    width:100%; max-width:720px; display:flex; justify-content:space-around; gap:6px;
    padding:6px; background: rgba(255,255,255,0.02); border-radius:14px;
  }
  .nav-btn{
    flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
    padding:6px 8px; border-radius:10px; cursor:pointer; color:var(--muted); font-size:12px;
  }
  .nav-btn.active{
    color:var(--white);
    background: linear-gradient(90deg,var(--accent), #e008f6);
    box-shadow: 0 8px 20px rgba(0,0,0,0.28);
    transform:translateY(-3px);
  }

  /* icon style */
  .icon {
    width:22px; height:22px; display:block;
  }

  /* Responsive: larger screens */
  @media(min-width:900px){
    .wrap{padding:26px 22px 110px}
    .profile-row .avatar{width:100px; height:100px; flex:0 0 100px}
    .page-title{font-size:20px}
    .bottom-nav{height:84px}
  }
</style>
</head>
<body>

<div class="wrap" role="main">
  <header class="page-header" aria-label="Header pagina">
    <div class="logo-pill">A+</div>
    <div>
      <div class="page-title">Aura — Dashboard</div>
      <div class="page-sub">Benvenuto — area personale</div>
    </div>
  </header>

  <!-- DASHBOARD SECTION -->
  <section id="section-dashboard" class="section" aria-labelledby="dashboard-title">
    <div class="card" aria-hidden="false">
      <div class="profile-row">
        <div class="avatar" id="avatar-wrap">
          <img id="profile-img" src="default-profile.png" alt="Immagine profilo" />
        </div>
        <div class="profile-meta">
          <h2 id="user-name">Caricamento...</h2>
          <p id="user-email"></p>
          <div class="mini-stats">
            <div class="stat">
              <div class="label">Saldo</div>
              <div class="value" id="saldo">Caricamento...</div>
            </div>
            <div class="stat">
              <div class="label">Badge</div>
              <div class="value" id="badge">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="bio-terminal" id="bio-display" aria-live="polite">
        <span id="bio-text">Caricamento...</span>
      </div>
      <div style="margin-top:10px; color:rgba(255,255,255,0.75); font-size:12px" id="user-uid"></div>
    </div>

    <div class="card" style="margin-top:8px">
      <h3 style="margin-bottom:10px; font-size:15px">Notizie recenti</h3>
      <div id="news-list">
        <div style="color:var(--muted)">Caricamento notizie...</div>
      </div>
    </div>
  </section>

  <!-- NEWS SECTION -->
  <section id="section-news" class="section" style="display:none">
    <div class="card">
      <h3 style="margin-bottom:10px">Notizie</h3>
      <div id="news-items">
        <div style="color:var(--muted)">Caricamento...</div>
      </div>
    </div>
  </section>

  <!-- SETTINGS SECTION -->
  <section id="section-settings" class="section" style="display:none">
    <div class="card">
      <h3 style="margin-bottom:10px">Impostazioni</h3>
      <div class="settings-list">
        <div class="settings-row"><div>Profilo</div><div style="color:var(--muted)">Modifica nome / immagine</div></div>
        <div class="settings-row"><div>Privacy</div><div style="color:var(--muted)">Controlla visibilità</div></div>
        <div class="settings-row"><div>Account</div><div style="color:var(--muted)">Gestisci email / password</div></div>
        <div class="settings-row"><div>Logout</div><div><button id="btn-logout" style="background:none;border:0;color:var(--accent);font-weight:700;cursor:pointer">Esci</button></div></div>
      </div>
    </div>
  </section>

</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav" role="navigation" aria-label="Navigazione principale">
  <div class="nav-inner" role="menubar">
    <div class="nav-btn active" id="nav-btn-dashboard" role="menuitem" aria-current="page" tabindex="0" onclick="showSection('dashboard')">
      <!-- Home icon -->
      <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>Dashboard</div>
    </div>

    <div class="nav-btn" id="nav-btn-news" role="menuitem" tabindex="0" onclick="showSection('news')">
      <!-- News icon -->
      <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.6"/><path d="M7 9h10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
      <div>Notizie</div>
    </div>

    <div class="nav-btn" id="nav-btn-settings" role="menuitem" tabindex="0" onclick="showSection('settings')">
      <!-- Settings icon -->
      <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.6"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.23-.4 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.83 2.34l.06.06c.46.4 1.08.46 1.61.2.49-.24 1.05-.37 1.62-.37H12c.57 0 1.13.13 1.62.37.53.26 1.15.2 1.61-.2l.06-.06A2 2 0 1 1 19.4 4.5l-.06.06c-.4.46-.46 1.08-.2 1.61.24.49.37 1.05.37 1.62V12c0 .57-.13 1.13-.37 1.62-.26.53-.2 1.15.2 1.61z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>Impostazioni</div>
    </div>
  </div>
</nav>

<script>
/* ---------------------------
   Firebase config (identico)
   --------------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
    authDomain: "myauraid-f03c6.firebaseapp.com",
    projectId: "myauraid-f03c6",
    storageBucket: "myauraid-f03c6.firebasestorage.app",
    messagingSenderId: "190478237725",
    appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* Helpers */
function $(id){ return document.getElementById(id) }
function showSection(name){
  // hide all then show target
  const sections = ['dashboard','news','settings'];
  sections.forEach(s => {
    const el = $('section-' + s) || $('section-' + s);
    if(el) el.style.display = (s === name) ? 'block' : 'none';
    // nav btn active state
    const btn = $('nav-btn-' + s);
    if(btn) {
      if(s === name) { btn.classList.add('active'); btn.setAttribute('aria-current','page') }
      else { btn.classList.remove('active'); btn.removeAttribute('aria-current') }
    }
  });
  // focus main for a11y
  document.activeElement.blur && document.activeElement.blur();
}

/* Image fallback (data URL SVG) */
const defaultAvatarSVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="100%" height="100%" rx="20" fill="#ffffff22"/><text x="50%" y="52%" font-size="36" text-anchor="middle" fill="#ffffff" font-family="Poppins, sans-serif" dy=".3em">A+</text></svg>`
);
function fixImg(imgEl){
  imgEl.onerror = null;
  imgEl.src = defaultAvatarSVG;
}

/* Typewriter bio */
function animateBio(text, el, speed=20){
  if(!el) return;
  el.textContent = '';
  let i = 0;
  (function step(){
    if(i < text.length){
      el.textContent += text.charAt(i++);
      setTimeout(step, speed);
    }
  })();
}

/* Auth handling */
auth.onAuthStateChanged(async (user) => {
  if(!user){
    window.location.href = 'login.html';
    return;
  }

  $('user-uid').textContent = 'UID: ' + user.uid;
  $('user-email').textContent = user.email ? 'Email: ' + user.email : '';

  try{
    const docRef = db.collection('users').doc(user.uid);
    const doc = await docRef.get();

    if(!doc.exists){
      // create default doc like nel tuo codice
      await docRef.set({ saldo:15, profileImage:'aurastudio.png', badge:'' });
      // fetch the new doc
      var data = (await docRef.get()).data();
    } else {
      var data = doc.data();
    }

    // Nome e cognome (fallback a displayName / Nome Cognome)
    const fullName = (data && data.nome && data.cognome) ? `${data.nome} ${data.cognome}` : (data && data.displayName) || user.displayName || 'Nome Cognome';
    $('user-name').textContent = fullName;

    // Saldo
    $('saldo').textContent = (data && data.saldo !== undefined) ? (data.saldo + " di saldo") : "0€";

    // Badge
    const badgeText = (data && data.badge && data.badge.trim() !== '') ? data.badge : 'Utente';
    $('badge').textContent = badgeText;

    // Profile image (con fallback)
    const profileImgUrl = (data && data.profileImage) ? data.profileImage : 'aurastudio.png';
    const imgEl = $('profile-img');
    imgEl.src = profileImgUrl;
    imgEl.onerror = function(){ fixImg(imgEl) };
    // ensure small top avatar updated if exists
    // top avatar uses same id 'profile-img' (single)
    // Bio
    const bioText = (data && data.bio && data.bio.description) ? data.bio.description : 'Nessuna descrizione impostata.';
    animateBio(bioText, $('bio-text'), 20);

    // Load news
    loadNews();

  }catch(err){
    console.error('Errore caricamento utente:', err);
    $('news-list').innerHTML = `<div style="color:#ffb4b4">Errore nel caricamento: controlla console.</div>`;
  }
});

/* Logout button in settings */
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'btn-logout'){
    auth.signOut().then(()=> window.location.href = 'login.html').catch(err => alert('Errore logout: '+err.message));
  }
});

/* Load news: robust fallback if orderBy fails */
async function loadNews(){
  const out = $('news-list');
  const outAll = $('news-items');
  out.innerHTML = '';
  outAll && (outAll.innerHTML = '');

  try{
    // prova a ordinare per createdAt (caso normale)
    const snap = await db.collection('news').orderBy('createdAt','desc').limit(8).get();
    if(snap.empty){
      out.innerHTML = `<div style="color:var(--muted)">Nessuna notizia recente.</div>`;
      outAll && (outAll.innerHTML = `<div style="color:var(--muted)">Nessuna notizia recente.</div>`);
      return;
    }
    snap.forEach(doc=>{
      const d = doc.data();
      appendNewsItem(out, d);
      outAll && appendNewsItem(outAll, d);
    });
  }catch(err){
    // fallback: se orderBy non funziona (es. campo mancante), prendi tutto e ordina in JS
    console.warn('OrderBy news fallito, fallback:', err);
    try{
      const snap2 = await db.collection('news').get();
      const list = [];
      snap2.forEach(doc=>{
        const d = doc.data();
        d._id = doc.id;
        // convert Firestore Timestamp to ms if possibile
        d._ts = (d.createdAt && d.createdAt.toDate) ? d.createdAt.toDate().getTime() : 0;
        list.push(d);
      });
      // sort desc by timestamp
      list.sort((a,b) => (b._ts || 0) - (a._ts || 0));
      if(list.length === 0){
        out.innerHTML = `<div style="color:var(--muted)">Nessuna notizia recente.</div>`;
        outAll && (outAll.innerHTML = `<div style="color:var(--muted)">Nessuna notizia recente.</div>`);
        return;
      }
      list.slice(0,8).forEach(d=>{
        appendNewsItem(out, d);
        outAll && appendNewsItem(outAll, d);
      });
    }catch(err2){
      console.error('Errore caricamento news fallback:', err2);
      out.innerHTML = `<div style="color:#ffb4b4">Errore nel caricare le notizie.</div>`;
    }
  }
}

/* Helper to add a news block */
function appendNewsItem(container, d){
  const title = d.title || 'Titolo';
  const summary = d.summary || (d.content ? d.content.substring(0,140) + '...' : 'Nessun testo.');
  const ts = (d.createdAt && d.createdAt.toDate) ? d.createdAt.toDate().toLocaleString() : (d._ts ? new Date(d._ts).toLocaleString() : '');
  const div = document.createElement('div');
  div.className = 'news-item';
  div.innerHTML = `<h4>${escapeHtml(title)}</h4><p>${escapeHtml(summary)}</p><div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:6px">${escapeHtml(ts)}</div>`;
  container.appendChild(div);
}

/* Simple escaping */
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* Accessibility: keyboard navigation for nav buttons */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
  });
});

/* Initial visible section */
showSection('dashboard');
</script>
</body>
</html>
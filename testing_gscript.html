<!DOCTYPE html>
<html lang="it">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Test Google Script - Device reale e posizione
  </title>
  <style>
   body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 400px; }
    #console { background: #222; color: #0f0; padding: 10px; height: 250px; overflow-y: auto; font-family: monospace; }
  </style>
 </head>
 <body>
  <h2>
   Test Google Script
  </h2>
  <input id="email" placeholder="Inserisci la tua email" type="email"/>
  <button id="testButton">
   Invia Test Email
  </button>
  <h3>
   Console virtuale:
  </h3>
  <div id="console">
  </div>
  <script>
   const consoleDiv = document.getElementById('console');
function log(msg) {
    consoleDiv.innerHTML += msg + '<br>';
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

// Ottieni nome dispositivo leggibile
function getDeviceName() {
    if (navigator.userAgentData && navigator.userAgentData.platform) {
        return navigator.userAgentData.platform + " " + navigator.userAgent;
    }
    return navigator.userAgent;
}

// Converti lat/lon in città + paese usando OpenStreetMap Nominatim
function reverseGeocode(lat, lon, callback) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
    .then(res => res.json())
    .then(data => {
        if (data.address) {
            const city = data.address.city || data.address.town || data.address.village || "Località sconosciuta";
            const country = data.address.country || "";
            callback(`${city}, ${country}`);
        } else {
            callback("Località sconosciuta");
        }
    })
    .catch(() => callback("Località sconosciuta"));
}

// Formatta timestamp leggibile
function getReadableTimestamp() {
    const now = new Date();
    return now.toLocaleString("it-IT", { dateStyle: "short", timeStyle: "short" });
}

document.getElementById('testButton').addEventListener('click', () => {
    const email = document.getElementById('email').value;
    if (!email) { log("Inserisci un'email valida."); return; }

    const deviceName = getDeviceName();
    const timestamp = getReadableTimestamp();

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                reverseGeocode(position.coords.latitude, position.coords.longitude, (location) => {
                    log(`Dispositivo: ${deviceName}`);
                    log(`Posizione: ${location}`);
                    log(`Timestamp: ${timestamp}`);
                    sendTest(email, deviceName, location, timestamp);
                });
            },
            (error) => {
                log("Geolocalizzazione non disponibile, invio senza posizione.");
                sendTest(email, deviceName, "Posizione non disponibile", timestamp);
            }
        );
    } else {
        log("Geolocalizzazione non supportata.");
        sendTest(email, deviceName, "Geolocalizzazione non supportata", timestamp);
    }
});

function sendTest(email, deviceName, location, timestamp) {
    fetch("https://script.google.com/macros/s/AKfycbxTUGexzYk9fl99phvPQfKzwgEk7kKd7DScZvjfT3B2cct8xis04G4MhkWHGs5K9PNe/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, deviceName, location, timestamp })
    })
    .then(response => response.text())
    .then(data => log("Risposta Web App: " + data))
    .catch(error => log("Errore fetch: " + error));
}
  </script>
 </body>
</html>
